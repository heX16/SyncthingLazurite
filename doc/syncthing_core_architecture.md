## Ядро: архитектура и работа с Syncthing

### Общая идея
Ядро подключается к Syncthing и поддерживает локальное представление его данных в виде одного дерева. Первичную загрузку выполняем через REST API, дальнейшие изменения получаем через Event API (long polling) и обновляем соответствующие ветви дерева.

### Справка и оффициальная документация Syncthinc

doc_local/dev/events.rst
doc_local/events/*
doc_local/rest_api_doc/*

### API Syncthing
- **REST API**: используется на старте для первичной загрузки данных и, при необходимости, для отдельных операций обновления.
- **Event API**: основной канал работы ядра после инициализации; получаем события об изменениях и соответствующие фрагменты JSON.

### Архитектура ядра
- **Глобальная переменная состояния (FSM)**: описывает текущее состояние ядра.
- **Дерево данных `root`**: хранит все данные, полученные от Syncthing, в памяти. В памяти поддерживается один корень `root`, содержащий все ветви данных, полученных от Syncthing.

### Дерево данных и формат хранения
- Если бы реализация велась на Python, было бы удобно хранить структуру как вложенные словари (`dict` из `dict`), формируя тем самым дерево данных простой природой языка.
- В Lazarus/Free Pascal нет столь же удобного и нативного аналога «словарь из словарей» для таких вложенных деревьев. Зато есть надёжная и предсказуемая JSON‑библиотека (например, `fpjson`/`jsonparser`), позволяющая строить и эффективно обрабатывать иерархические структуры.
- Поэтому формат хранения — JSON‑дерево на базе библиотек Lazarus: оно обеспечивает быстрые операции, понятную модель, удобную замену ветвей и совместимость с форматом данных Syncthing.

### Инициализация и первичная синхронизация
1. При инициализации создаётся дефолтное дерево `root`.
2. При подключении к Syncthing выполняется выгрузка данных через REST API.
3. Полученные JSON‑структуры напрямую интегрируются в `root` путём замены соответствующих ветвей.

### Подписка на события и long polling
- После первичной синхронизации активируется long polling к Event API.
- На каждое событие Syncthing присылает, какой endpoint изменился, и полный JSON соответствующего участка данных.
- Ядро:
  1) вызывает пользовательский обработчик события с сырыми данными;
  2) обновляет дерево (`root`) — заменяет затронутую ветвь данными из события, таким образом поддерживая синхронность дерева данных с Syncthing;
  3) вызывает обработчик «изменения пути» с указанием обновлённого пути.

- Периодический реинициализатор long polling: раз в заданный интервал (например, 1–10 минут) соединение закрывается и открывается заново; перед повторным открытием вызывается соответствующий обработчик.

### Режим подключения
- Ядро поддерживает подключение только к уже запущенному экземпляру Syncthing.
- Доступны методы: `connect` и `disconnect`.

### Обработчики (callbacks) ядра
- **onBeforeConnect**: начало процедуры подключения (до фактических действий).
- **onConnected**: успешное подключение.
- **onConnectError**: ошибка подключения.
- **onBeforeDisconnect**: начало процедуры отключения (до фактических действий).
- **onDisconnectedByUser**: успешное завершение отключения по инициативе пользователя.
- **onHardDisconnect**: полный разрыв связи по инициативе сервера, восстановить связь в разумный срок не удалось; ядро объявляет дисконнект и переходит в офлайн.
- **onLongPollingDrop**: внезапный разрыв long‑polling (ещё не считаем это полным дисконнектом). Обработчик возвращает режим дальнейших действий:
  - default: поведение по умолчанию;
  - retry: продолжать попытки восстановления соединения;
  - abort: завершить соединение и перейти в офлайн.
  После вызова этого обработчика ядро начинает процедуру восстановления соединения согласно возвращённому режиму.
- **onBeforeLongPollingRestart**: периодическое переоткрытие long‑polling; вызывается после закрытия, но до повторного открытия.
- **onEvent**: входящее событие Event API; ядро сначала вызывает этот обработчик с полученными данными, затем выполняет свою обработку (интеграцию в дерево).
- **onPathChanged(path)**: после интеграции данных в `root` — уведомление об изменении конкретного пути для реакции приложения (например, обновить UI).
- **onBeforeTreeModify**: сигнал перед началом модификации дерева (для синхронизации потоков/блокировок).
- **onAfterTreeModify**: сигнал о завершении модификации дерева (снятие блокировок/возобновление визуализации).

### Машина состояний (FSM)
- **offline**: ядро отключено.
- **connecting**: выполняется процедура подключения.
- **online**: активная работа, long polling запущен.
- **disconnecting**: выполняется процедура отключения.

Переходы прямолинейны: offline → connecting → online → disconnecting → offline, с ветвлениями на ошибках и разрывах (см. обработчики выше).

